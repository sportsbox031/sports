<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스포츠박스 예약시스템</title>
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        .calendar-day:hover {
            background-color: rgba(59, 130, 246, 0.1);
            transition: all 0.3s;
        }
        .selected {
            background-color: #3B82F6 !important;
            color: white !important;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal.show {
            display: flex;
        }
        .calendar-day.booked {
            background-color: #FEF3C7;
            cursor: pointer;
        }
        .calendar-day.full {
            background-color: #FEE2E2;
            cursor: not-allowed;
        }
        .calendar-day.past {
            background-color: #F3F4F6;
            cursor: not-allowed;
            color: #9CA3AF;
        }
        .calendar-day.closed {
            background-color: #EF4444;
            color: white;
            cursor: not-allowed;
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loading.show {
            display: flex;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

<!-- 로딩 인디케이터 -->
<div id="loading" class="loading">
    <div class="spinner"></div>
</div>

<!-- 알림 메시지 -->
<div id="alert" class="fixed top-4 right-4 max-w-sm bg-white rounded-lg shadow-lg p-4 hidden z-50">
    <div class="flex items-center">
        <div id="alertIcon" class="flex-shrink-0">
            <i class="fas fa-info-circle text-blue-500"></i>
        </div>
        <div class="ml-3">
            <p id="alertMessage" class="text-sm text-gray-700"></p>
        </div>
        <button onclick="hideAlert()" class="ml-4">
            <i class="fas fa-times text-gray-400 hover:text-gray-500"></i>
        </button>
    </div>
</div>

<!-- 날짜 마감 설정 모달 (관리자용) -->
<div id="closeDateModal" class="modal">
    <div class="bg-white p-8 rounded-lg shadow-md w-96 m-auto">
        <h2 class="text-2xl font-bold mb-6 text-center">날짜 마감 설정</h2>
        <form id="closeDateForm" class="space-y-4">
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">시작 날짜</label>
                <input type="date" id="closeStartDate" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">종료 날짜</label>
                <input type="date" id="closeEndDate" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
            </div>
            <button type="submit" 
                class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition duration-200">
                마감 처리
            </button>
            <button type="button" onclick="closeModal('closeDateModal')"
                class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition duration-200">
                취소
            </button>
        </form>
    </div>
</div>

<!-- 로그인 화면 -->
<div id="loginScreen" class="min-h-screen bg-gray-100 flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-md w-96">
        <h1 class="text-2xl font-bold mb-6 text-center">스포츠박스 로그인</h1>
        <form id="loginForm" class="space-y-4">
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">아이디</label>
                <input type="text" id="username" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">비밀번호</label>
                <input type="password" id="password" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
            </div>
            <button type="submit" 
                class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                로그인
            </button>
        </form>
        <button id="showSignup" 
            class="w-full mt-4 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition duration-200">
            회원가입
        </button>
    </div>
</div>

<!-- 회원가입 모달 -->
<div id="signupModal" class="modal">
    <div class="bg-white p-8 rounded-lg shadow-md w-96 m-auto">
        <h2 class="text-2xl font-bold mb-6 text-center">회원가입</h2>
        <form id="signupForm" class="space-y-4">
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">단체명</label>
                <input type="text" id="groupName" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">비밀번호</label>
                <input type="password" id="signupPassword" required minlength="6"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                <p class="text-sm text-gray-500 mt-1">6자 이상 입력해주세요</p>
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">담당자</label>
                <input type="text" id="manager" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">연락처</label>
                <input type="text" id="contact" required
                    placeholder="예: 010-1234-5678"
                    pattern="[0-9]{2,3}-[0-9]{3,4}-[0-9]{4}"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                <p class="text-sm text-gray-500 mt-1">형식: 010-0000-0000</p>
            </div>
            <button type="submit" 
                class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                가입하기
            </button>
            <button type="button" id="closeSignup"
                class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition duration-200">
                닫기
            </button>
        </form>
    </div>
</div>

<!-- 사용자 대시보드 -->
<div id="userDashboard" class="hidden">
    <nav class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-running text-2xl"></i>
                    <span class="text-2xl font-bold">스포츠박스</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="userGroupName" class="text-sm"></span>
                    <button id="logoutBtn" class="hover:text-blue-200 transition-colors duration-200 flex items-center space-x-1">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>로그아웃</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-8">
        <div class="grid md:grid-cols-2 gap-8">
            <!-- 캘린더 섹션 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-700">예약 현황</h2>
                    <div class="flex space-x-4">
                        <button id="prevMonth" class="p-2 hover:bg-blue-100 rounded-full transition-colors duration-200">
                            <i class="fas fa-chevron-left text-blue-600"></i>
                        </button>
                        <span id="currentMonth" class="p-2 font-medium text-gray-700"></span>
                        <button id="nextMonth" class="p-2 hover:bg-blue-100 rounded-full transition-colors duration-200">
                            <i class="fas fa-chevron-right text-blue-600"></i>
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-7 gap-2 mb-2">
                    <div class="text-center font-medium text-gray-600">일</div>
                    <div class="text-center font-medium text-gray-600">월</div>
                    <div class="text-center font-medium text-gray-600">화</div>
                    <div class="text-center font-medium text-gray-600">수</div>
                    <div class="text-center font-medium text-gray-600">목</div>
                    <div class="text-center font-medium text-gray-600">금</div>
                    <div class="text-center font-medium text-gray-600">토</div>
                </div>
                <div id="calendar" class="grid grid-cols-7 gap-2"></div>
                <div class="mt-4 flex justify-end space-x-4">
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-yellow-100 rounded mr-2"></div>
                        <span class="text-sm text-gray-600">예약가능</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-red-100 rounded mr-2"></div>
                        <span class="text-sm text-gray-600">예약마감</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-red-500 rounded mr-2"></div>
                        <span class="text-sm text-gray-600">관리자 마감</span>
                    </div>
                </div>
            </div>

            <!-- 예약 정보 섹션 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-700">예약하기</h2>
                    <div id="remainingBookings" class="text-sm font-medium text-green-600">
                        이번 달 남은 예약 가능 횟수: 4회
                    </div>
                </div>
                <form id="bookingForm" class="space-y-6">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">선택된 날짜</label>
                        <input type="text" id="selectedDate" readonly required
                            class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">시작 시간</label>
                            <select id="startTime" required
                                class="w-full p-3 border border-gray-300 rounded-lg">
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">종료 시간</label>
                            <select id="endTime" required
                                class="w-full p-3 border border-gray-300 rounded-lg">
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">인원</label>
                            <input type="number" id="people" required min="1"
                                class="w-full p-3 border border-gray-300 rounded-lg">
                            <p class="text-sm text-gray-500 mt-1">수업 인원을 입력하세요</p>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">장소</label>
                            <input type="text" id="place" required
                                class="w-full p-3 border border-gray-300 rounded-lg"
                                placeholder="수업 장소를 입력하세요">
                        </div>
                    </div>
                    <button type="submit" 
                        class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-200">
                        예약하기
                    </button>
                </form>
            </div>
        </div>

        <!-- 내 예약 목록 -->
        <div class="mt-8 bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold text-gray-700 mb-6">내 예약 목록</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                날짜
                            </th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                시간
                            </th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                장소
                            </th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                인원
                            </th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                상태
                            </th>
                        </tr>
                    </thead>
                    <tbody id="bookingsList" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<!-- 관리자 대시보드 -->
<div id="adminDashboard" class="hidden">
    <nav class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-running text-2xl"></i>
                    <span class="text-2xl font-bold">스포츠박스 관리자</span>
                </div>
                <div class="flex space-x-8">
                    <button id="showCloseDateModal" 
                        class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                        날짜 마감 설정
                    </button>
                    <button id="adminLogoutBtn" 
                        class="hover:text-blue-200 transition-colors duration-200 flex items-center space-x-1">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>로그아웃</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-8">
        <!-- 관리자용 캘린더 -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-700">예약 현황</h2>
                <div class="flex space-x-4">
                    <button id="adminPrevMonth" class="p-2 hover:bg-blue-100 rounded-full transition-colors duration-200">
                        <i class="fas fa-chevron-left text-blue-600"></i>
                    </button>
                    <span id="adminCurrentMonth" class="p-2 font-medium text-gray-700"></span>
                    <button id="adminNextMonth" class="p-2 hover:bg-blue-100 rounded-full transition-colors duration-200">
                        <i class="fas fa-chevron-right text-blue-600"></i>
                    </button>
                </div>
            </div>
            <div class="grid grid-cols-7 gap-2 mb-2">
                <div class="text-center font-medium text-gray-600">일</div>
                <div class="text-center font-medium text-gray-600">월</div>
                <div class="text-center font-medium text-gray-600">화</div>
                <div class="text-center font-medium text-gray-600">수</div>
                <div class="text-center font-medium text-gray-600">목</div>
                <div class="text-center font-medium text-gray-600">금</div>
                <div class="text-center font-medium text-gray-600">토</div>
            </div>
            <div id="adminCalendar" class="grid grid-cols-7 gap-2"></div>
            <div class="mt-4 flex justify-end space-x-4">
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-yellow-100 rounded mr-2"></div>
                    <span class="text-sm text-gray-600">예약있음</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-red-100 rounded mr-2"></div>
                    <span class="text-sm text-gray-600">예약마감</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-red-500 rounded mr-2"></div>
                    <span class="text-sm text-gray-600">마감처리됨</span>
                </div>
            </div>
        </div>

        <!-- 회원가입 승인 목록 -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-700 mb-6">회원가입 승인 대기</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                단체명
                            </th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                담당자
                            </th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                연락처
                            </th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                관리
                            </th>
                        </tr>
                    </thead>
                    <tbody id="pendingUsersList" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 예약 승인 목록 -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold text-gray-700 mb-6">예약 승인 대기</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                단체명
                            </th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                날짜
                            </th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                시간
                            </th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                장소
                            </th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                인원
                            </th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                관리
                            </th>
                        </tr>
                    </thead>
                    <tbody id="pendingBookingsList" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<script>
    // 상수 및 전역 변수 설정
    const API_BASE_URL = 'https://sports-box-api.sportsbox031.workers.dev';
    const DEBUG = true;
    
    // 관리자 계정 정보
    const ADMIN_CREDENTIALS = {
        username: 'admin',
        password: 'admin123'
    };
    
    let currentUser = null;
    let bookingStatus = {};
    let isLoading = false;
    let closedDates = [];
    
    // 유틸리티 함수들
    function showLoading() {
        if (!isLoading) {
            isLoading = true;
            document.getElementById('loading').classList.add('show');
        }
    }
    
    function hideLoading() {
        isLoading = false;
        document.getElementById('loading').classList.remove('show');
    }
    
    function showAlert(message, type = 'info') {
        const alert = document.getElementById('alert');
        const alertMessage = document.getElementById('alertMessage');
        const alertIcon = document.getElementById('alertIcon').firstElementChild;
    
        alertMessage.textContent = message;
        alert.classList.remove('hidden');
    
        switch(type) {
            case 'success':
                alertIcon.className = 'fas fa-check-circle text-green-500';
                break;
            case 'error':
                alertIcon.className = 'fas fa-exclamation-circle text-red-500';
                break;
            default:
                alertIcon.className = 'fas fa-info-circle text-blue-500';
        }
    
        setTimeout(hideAlert, 3000);
    }
    
    function hideAlert() {
        document.getElementById('alert').classList.add('hidden');
    }
    
    function showModal(modalId) {
        document.getElementById(modalId).classList.add('show');
    }
    
    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('show');
    }
    
    // API 요청 헬퍼 함수
    async function apiRequest(endpoint, options = {}) {
        showLoading();
        try {
            const token = localStorage.getItem('token');
            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token ? `Bearer ${token}` : '',
                    ...options.headers
                }
            });
    
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.message || `HTTP error! status: ${response.status}`);
            }
    
            return data;
        } catch (error) {
            console.error('API Request Error:', error);
            throw error;
        } finally {
            hideLoading();
        }
    }
    
    // 날짜 관련 유틸리티 함수들
    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일`;
    }
    
    function formatDateForAPI(date) {
        return date.toISOString().split('T')[0];
    }
    
    function isDateClosed(dateStr) {
        return closedDates.some(range => {
            const date = new Date(dateStr);
            const start = new Date(range.startDate);
            const end = new Date(range.endDate);
            return date >= start && date <= end;
        });
    }
    
    // 상태 관련 유틸리티 함수들
    function getStatusClass(status) {
        switch(status) {
            case 'approved':
                return 'bg-green-100 text-green-800';
            case 'pending':
                return 'bg-yellow-100 text-yellow-800';
            case 'rejected':
                return 'bg-red-100 text-red-800';
            case 'closed':
                return 'bg-red-500 text-white';
            default:
                return 'bg-gray-100 text-gray-800';
        }
    }
    
    function getStatusText(status) {
        switch(status) {
            case 'approved':
                return '승인완료';
            case 'pending':
                return '승인대기';
            case 'rejected':
                return '거부됨';
            case 'closed':
                return '마감';
            default:
                return '알 수 없음';
        }
    }
    
    // 달력 날짜 검증 함수
    function isValidDate(date) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // 과거 날짜 체크
        if (date < today) return false;
        
        // 마감된 날짜 체크
        if (isDateClosed(date)) return false;
        
        // 예약 가능 여부 체크
        const dateStr = formatDateForAPI(date);
        const status = bookingStatus[dateStr];
        
        return !status?.isFull;
    }
    
    // 남은 예약 가능 횟수 계산
    function calculateRemainingBookings() {
        const currentMonth = new Date().getMonth() + 1;
        const monthlyBookings = Object.values(bookingStatus)
            .filter(status => 
                status.isCurrentMonth && 
                status.isMyBooking && 
                ['approved', 'pending'].includes(status.status)
            ).length;
        
        return 4 - monthlyBookings;
    }

// 인증 관련 함수들
async function login(username, password) {
    try {
        const response = await apiRequest('/api/login', {
            method: 'POST',
            body: JSON.stringify({ username, password })
        });

        if (response.success) {
            localStorage.setItem('token', response.token);
            localStorage.setItem('role', response.role);
            localStorage.setItem('username', response.username);
            
            currentUser = {
                username: response.username,
                role: response.role
            };
            
            showDashboard(response.role);
            showAlert('로그인되었습니다.', 'success');
        }
    } catch (error) {
        console.error('Login error:', error);
        showAlert(error.message || '로그인에 실패했습니다.', 'error');
    }
}

function logout() {
    localStorage.removeItem('token');
    localStorage.removeItem('role');
    localStorage.removeItem('username');
    
    currentUser = null;
    bookingStatus = {};
    closedDates = [];
    
    document.getElementById('adminDashboard').style.display = 'none';
    document.getElementById('userDashboard').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
    
    showAlert('로그아웃되었습니다.', 'info');
}

async function signup(formData) {
    try {
        const response = await apiRequest('/api/signup', {
            method: 'POST',
            body: JSON.stringify({
                groupName: formData.groupName,
                password: formData.password,
                manager: formData.manager,
                contact: formData.contact
            })
        });

        if (response.success) {
            showAlert('회원가입 신청이 완료되었습니다. 관리자 승인을 기다려주세요.', 'success');
            closeModal('signupModal');
            document.getElementById('signupForm').reset();
        }
    } catch (error) {
        console.error('Signup error:', error);
        showAlert(error.message || '회원가입 처리 중 오류가 발생했습니다.', 'error');
    }
}

function showDashboard(role) {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('adminDashboard').style.display = 'none';
    document.getElementById('userDashboard').style.display = 'none';

    if (role === 'admin') {
        document.getElementById('adminDashboard').style.display = 'block';
        initializeAdminDashboard();
    } else {
        document.getElementById('userDashboard').style.display = 'block';
        if (localStorage.getItem('username')) {
            document.getElementById('userGroupName').textContent = 
                localStorage.getItem('username');
        }
        initializeUserDashboard();
    }
}

// 자동 로그인 체크
function checkAutoLogin() {
    const token = localStorage.getItem('token');
    const role = localStorage.getItem('role');
    const username = localStorage.getItem('username');

    if (token && role && username) {
        currentUser = { username, role };
        showDashboard(role);
    }
}

// 관리자: 사용자 승인/거부
async function approveUser(userId) {
    try {
        const response = await apiRequest(`/api/admin/users/${userId}/approve`, {
            method: 'PUT'
        });
        if (response.success) {
            showAlert('사용자가 승인되었습니다.', 'success');
            loadPendingUsers();
        }
    } catch (error) {
        console.error('User approval error:', error);
        showAlert('사용자 승인 처리 중 오류가 발생했습니다.', 'error');
    }
}

async function rejectUser(userId) {
    try {
        const response = await apiRequest(`/api/admin/users/${userId}/reject`, {
            method: 'PUT'
        });
        if (response.success) {
            showAlert('사용자가 거부되었습니다.', 'success');
            loadPendingUsers();
        }
    } catch (error) {
        console.error('User rejection error:', error);
        showAlert('사용자 거부 처리 중 오류가 발생했습니다.', 'error');
    }
}

// 관리자: 가입 대기 사용자 목록 로드
async function loadPendingUsers() {
    try {
        const data = await apiRequest('/api/admin/pending-users');
        const tbody = document.getElementById('pendingUsersList');
        
        if (data.success && data.data) {
            tbody.innerHTML = data.data.map(user => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">${user.groupName}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${user.manager}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${user.contact}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button onclick="approveUser(${user.id})" 
                            class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 mr-2">
                            승인
                        </button>
                        <button onclick="rejectUser(${user.id})" 
                            class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                            거부
                        </button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="4" class="px-6 py-4 text-center">대기 중인 회원이 없습니다.</td></tr>';
        }
    } catch (error) {
        console.error('Error loading pending users:', error);
        showAlert('가입 대기 목록을 불러오는데 실패했습니다.', 'error');
    }
}

// 예약 관련 함수들
async function createBooking(bookingData) {
    try {
        const response = await apiRequest('/api/bookings', {
            method: 'POST',
            body: JSON.stringify({
                date: bookingData.date,
                startTime: bookingData.startTime,
                endTime: bookingData.endTime,
                people: bookingData.people,
                place: bookingData.place
            })
        });

        if (response.success) {
            showAlert('예약이 신청되었습니다. 관리자 승인을 기다려주세요.', 'success');
            document.getElementById('bookingForm').reset();
            await loadBookings();
            await updateCalendarStatus();
        }
    } catch (error) {
        console.error('Booking creation error:', error);
        showAlert(error.message || '예약 생성 중 오류가 발생했습니다.', 'error');
    }
}

// 예약 목록 로드
async function loadBookings() {
    try {
        const data = await apiRequest('/api/bookings');
        const tbody = document.getElementById('bookingsList');
        
        if (data.success && data.data) {
            tbody.innerHTML = data.data.map(booking => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">${formatDate(booking.date)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${booking.startTime} - ${booking.endTime}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${booking.place}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${booking.people}명</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                            ${getStatusClass(booking.status)}">
                            ${getStatusText(booking.status)}
                        </span>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="5" class="px-6 py-4 text-center">예약 내역이 없습니다.</td></tr>';
        }
    } catch (error) {
        console.error('Error loading bookings:', error);
        showAlert('예약 목록을 불러오는데 실패했습니다.', 'error');
    }
}

// 관리자: 예약 승인 대기 목록 로드
async function loadPendingBookings() {
    try {
        const data = await apiRequest('/api/admin/pending-bookings');
        const tbody = document.getElementById('pendingBookingsList');
        
        if (data.success && data.data) {
            tbody.innerHTML = data.data.map(booking => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">${booking.groupName}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${formatDate(booking.date)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${booking.startTime} - ${booking.endTime}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${booking.place}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${booking.people}명</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button onclick="approveBooking(${booking.id})" 
                            class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 mr-2">
                            승인
                        </button>
                        <button onclick="rejectBooking(${booking.id})" 
                            class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                            거부
                        </button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="6" class="px-6 py-4 text-center">대기 중인 예약이 없습니다.</td></tr>';
        }
    } catch (error) {
        console.error('Error loading pending bookings:', error);
        showAlert('예약 승인 대기 목록을 불러오는데 실패했습니다.', 'error');
    }
}

// 관리자: 예약 승인/거부
async function approveBooking(bookingId) {
    try {
        const response = await apiRequest(`/api/admin/bookings/${bookingId}/approve`, {
            method: 'PUT'
        });
        if (response.success) {
            showAlert('예약이 승인되었습니다.', 'success');
            loadPendingBookings();
            updateCalendarStatus();
        }
    } catch (error) {
        console.error('Booking approval error:', error);
        showAlert('예약 승인 처리 중 오류가 발생했습니다.', 'error');
    }
}

async function rejectBooking(bookingId) {
    try {
        const response = await apiRequest(`/api/admin/bookings/${bookingId}/reject`, {
            method: 'PUT'
        });
        if (response.success) {
            showAlert('예약이 거부되었습니다.', 'success');
            loadPendingBookings();
            updateCalendarStatus();
        }
    } catch (error) {
        console.error('Booking rejection error:', error);
        showAlert('예약 거부 처리 중 오류가 발생했습니다.', 'error');
    }
}

// 관리자: 날짜 마감 처리
async function closeDateRange(startDate, endDate) {
    try {
        const response = await apiRequest('/api/admin/close-dates', {
            method: 'POST',
            body: JSON.stringify({ startDate, endDate })
        });

        if (response.success) {
            showAlert('선택한 날짜가 마감 처리되었습니다.', 'success');
            await loadClosedDates();
            await updateCalendarStatus();
            return true;
        }
    } catch (error) {
        console.error('Date closing error:', error);
        showAlert('날짜 마감 처리 중 오류가 발생했습니다.', 'error');
        return false;
    }
}

// 마감된 날짜 목록 로드
async function loadClosedDates() {
    try {
        const response = await apiRequest('/api/closed-dates');
        if (response.success) {
            closedDates = response.data;
            return response.data;
        }
    } catch (error) {
        console.error('Error loading closed dates:', error);
        showAlert('마감된 날짜 정보를 불러오는데 실패했습니다.', 'error');
        return [];
    }
}

// 캘린더 관련 변수와 함수들
let currentDate = new Date();
let calendar, currentMonthElement, selectedDateInput;

function initializeCalendar() {
    calendar = document.getElementById('calendar');
    currentMonthElement = document.getElementById('currentMonth');
    selectedDateInput = document.getElementById('selectedDate');

    document.getElementById('prevMonth').addEventListener('click', function() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar(currentDate);
    });

    document.getElementById('nextMonth').addEventListener('click', function() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar(currentDate);
    });

    renderCalendar(currentDate);
}

function initializeAdminCalendar() {
    const adminCalendar = document.getElementById('adminCalendar');
    const adminCurrentMonthElement = document.getElementById('adminCurrentMonth');

    document.getElementById('adminPrevMonth').addEventListener('click', function() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderAdminCalendar(currentDate);
    });

    document.getElementById('adminNextMonth').addEventListener('click', function() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderAdminCalendar(currentDate);
    });

    renderAdminCalendar(currentDate);
}

async function updateCalendarStatus() {
    try {
        const data = await apiRequest('/api/bookings/status');
        bookingStatus = data.data;

        // 마감된 날짜 정보 로드
        await loadClosedDates();

        // 현재 월의 예약 횟수 표시
        const monthlyCount = Object.values(bookingStatus)
            .filter(status => 
                status.isCurrentMonth && 
                status.isMyBooking && 
                ['approved', 'pending'].includes(status.status)
            ).length;

        // 남은 예약 가능 횟수 표시
        const remainingBookings = 4 - monthlyCount;
        const bookingCountElement = document.getElementById('remainingBookings');
        if (bookingCountElement) {
            bookingCountElement.textContent = `이번 달 남은 예약 가능 횟수: ${remainingBookings}회`;
            bookingCountElement.className = `text-sm font-medium ${
                remainingBookings > 0 ? 'text-green-600' : 'text-red-600'
            }`;
        }

        // 캘린더 새로고침
        if (currentUser?.role === 'admin') {
            renderAdminCalendar(currentDate);
        } else {
            renderCalendar(currentDate);
        }
    } catch (error) {
        console.error('Calendar status update error:', error);
        showAlert('캘린더 상태 업데이트에 실패했습니다.', 'error');
    }
}

function renderCalendar(date) {
    const year = date.getFullYear();
    const month = date.getMonth();
    
    currentMonthElement.textContent = `${year}년 ${month + 1}월`;

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    
    calendar.innerHTML = '';

    // 첫째 날의 요일만큼 빈 칸 추가
    for (let i = 0; i < firstDay.getDay(); i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'h-12 rounded-lg';
        calendar.appendChild(emptyDay);
    }

    // 날짜 채우기
    for (let day = 1; day <= lastDay.getDate(); day++) {
        const dayElement = document.createElement('div');
        const currentDateObj = new Date(year, month, day);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const dateString = formatDateForAPI(currentDateObj);
        const dateStatus = bookingStatus[dateString];

        // 날짜 상태에 따른 스타일 적용
        if (currentDateObj < today) {
            dayElement.className = 'calendar-day past h-12 flex items-center justify-center';
            dayElement.title = '지난 날짜';
        } else if (isDateClosed(dateString)) {
            dayElement.className = 'calendar-day closed h-12 flex items-center justify-center';
            dayElement.title = '관리자 마감';
        } else if (dateStatus?.isFull) {
            dayElement.className = 'calendar-day full h-12 flex items-center justify-center';
            dayElement.title = '예약 마감';
        } else if (dateStatus?.hasBooking) {
            dayElement.className = 'calendar-day booked h-12 flex items-center justify-center cursor-pointer';
            dayElement.title = `${dateStatus.bookingCount}개 예약됨`;
            addDateClickHandler(dayElement, year, month, day);
        } else {
            dayElement.className = 'calendar-day h-12 flex items-center justify-center cursor-pointer rounded-lg hover:bg-blue-100 transition-colors text-gray-700';
            addDateClickHandler(dayElement, year, month, day);
        }

        dayElement.textContent = day;

        // 오늘 날짜 표시
        if (
            day === today.getDate() &&
            month === today.getMonth() &&
            year === today.getFullYear()
        ) {
            dayElement.classList.add('bg-blue-100', 'font-bold');
        }

        calendar.appendChild(dayElement);
    }
}

function renderAdminCalendar(date) {
    const adminCalendar = document.getElementById('adminCalendar');
    const adminCurrentMonthElement = document.getElementById('adminCurrentMonth');
    
    const year = date.getFullYear();
    const month = date.getMonth();
    
    adminCurrentMonthElement.textContent = `${year}년 ${month + 1}월`;

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    
    adminCalendar.innerHTML = '';

    // 첫째 날의 요일만큼 빈 칸 추가
    for (let i = 0; i < firstDay.getDay(); i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'h-12 rounded-lg';
        adminCalendar.appendChild(emptyDay);
    }

    // 날짜 채우기
    for (let day = 1; day <= lastDay.getDate(); day++) {
        const dayElement = document.createElement('div');
        const currentDateObj = new Date(year, month, day);
        const dateString = formatDateForAPI(currentDateObj);
        const dateStatus = bookingStatus[dateString];

        // 관리자용 날짜 상태 표시
        if (isDateClosed(dateString)) {
            dayElement.className = 'calendar-day closed h-12 flex items-center justify-center';
            dayElement.title = '마감됨';
        } else if (dateStatus?.hasBooking) {
            dayElement.className = 'calendar-day booked h-12 flex items-center justify-center';
            dayElement.title = `${dateStatus.bookingCount}개 예약`;
        } else {
            dayElement.className = 'calendar-day h-12 flex items-center justify-center cursor-pointer rounded-lg hover:bg-blue-100 transition-colors text-gray-700';
        }

        dayElement.textContent = day;
        
        // 날짜 클릭 이벤트 (관리자용)
        dayElement.addEventListener('click', () => {
            const selected = adminCalendar.querySelector('.selected');
            if (selected) {
                selected.classList.remove('selected');
            }
            dayElement.classList.add('selected');
        });

        adminCalendar.appendChild(dayElement);
    }
}

function addDateClickHandler(element, year, month, day) {
    element.addEventListener('click', function() {
        const selected = calendar.querySelector('.selected');
        if (selected) {
            selected.classList.remove('selected');
        }
        element.classList.add('selected');
        
        const date = new Date(year, month, day);
        selectedDateInput.value = formatDate(date);
    });
}

// 시간 선택 초기화
function initializeTimeSelects() {
    const startTimeSelect = document.getElementById('startTime');
    const endTimeSelect = document.getElementById('endTime');
    
    function generateTimeOptions() {
        const times = [];
        // 9시부터 18시까지, 10분 단위로 시간 옵션 생성
        for (let hour = 9; hour < 18; hour++) {
            for (let minute = 0; minute < 60; minute += 10) {
                const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                times.push(timeString);
            }
        }
        return times;
    }

    const timeOptions = generateTimeOptions();
    
    // 시작 시간 옵션 설정
    startTimeSelect.innerHTML = '<option value="">선택해주세요</option>' + 
        timeOptions.map(time => `<option value="${time}">${time}</option>`).join('');

    // 시작 시간 선택 시 종료 시간 옵션 업데이트
    startTimeSelect.addEventListener('change', function() {
        const selectedIndex = timeOptions.indexOf(this.value);
        endTimeSelect.innerHTML = '<option value="">선택해주세요</option>' + 
            timeOptions.slice(selectedIndex + 1).map(time => 
                `<option value="${time}">${time}</option>`
            ).join('');
    });
}

// 주기적으로 예약 목록 갱신
function startBookingRefresh() {
    setInterval(async () => {
        const role = localStorage.getItem('role');
        if (role === 'admin') {
            if (document.getElementById('pendingUsersList').offsetParent !== null) {
                await loadPendingUsers();
            }
            if (document.getElementById('pendingBookingsList').offsetParent !== null) {
                await loadPendingBookings();
            }
        } else {
            if (document.getElementById('bookingsList').offsetParent !== null) {
                await loadBookings();
                await updateCalendarStatus();
            }
        }
    }, 30000); // 30초마다 갱신
}

// 이벤트 리스너 설정
document.addEventListener('DOMContentLoaded', function() {
    // 로그인 폼 이벤트 리스너
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        await login(username, password);
    });

    // 회원가입 모달 제어
    document.getElementById('showSignup').addEventListener('click', function() {
        showModal('signupModal');
    });

    document.getElementById('closeSignup').addEventListener('click', function() {
        closeModal('signupModal');
        document.getElementById('signupForm').reset();
    });

    // 회원가입 폼 제출
    document.getElementById('signupForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = {
            groupName: document.getElementById('groupName').value,
            password: document.getElementById('signupPassword').value,
            manager: document.getElementById('manager').value,
            contact: document.getElementById('contact').value
        };
        await signup(formData);
    });

    // 로그아웃 버튼
    document.getElementById('logoutBtn')?.addEventListener('click', logout);
    document.getElementById('adminLogoutBtn')?.addEventListener('click', logout);

    // 날짜 마감 설정 버튼 (관리자용)
    document.getElementById('showCloseDateModal')?.addEventListener('click', function() {
        showModal('closeDateModal');
    });

    // 날짜 마감 폼 제출
    document.getElementById('closeDateForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        const startDate = document.getElementById('closeStartDate').value;
        const endDate = document.getElementById('closeEndDate').value;
        
        if (await closeDateRange(startDate, endDate)) {
            closeModal('closeDateModal');
            this.reset();
        }
    });

    // 예약 폼 제출
    document.getElementById('bookingForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const remainingBookings = parseInt(document.getElementById('remainingBookings')
            .textContent.match(/\d+/)[0]);
        
        if (remainingBookings <= 0) {
            showAlert('이번 달 예약 가능 횟수를 모두 사용하셨습니다.', 'error');
            return;
        }

        const selectedDate = document.getElementById('selectedDate').value;
        if (!selectedDate) {
            showAlert('날짜를 선택해주세요.', 'error');
            return;
        }

        const startTime = document.getElementById('startTime').value;
        const endTime = document.getElementById('endTime').value;
        if (!startTime || !endTime) {
            showAlert('시간을 선택해주세요.', 'error');
            return;
        }

        const people = parseInt(document.getElementById('people').value);
        if (!people || people < 1) {
            showAlert('올바른 인원 수를 입력해주세요.', 'error');
            return;
        }

        const place = document.getElementById('place').value.trim();
        if (!place) {
            showAlert('장소를 입력해주세요.', 'error');
            return;
        }

        const bookingData = {
            date: selectedDate,
            startTime,
            endTime,
            people,
            place
        };

        await createBooking(bookingData);
    });

    // 초기화 함수 호출
    initializeTimeSelects();
    checkAutoLogin();
    startBookingRefresh();
});

// 웹소켓 연결 설정 (실시간 업데이트)
function initializeWebSocket() {
    const ws = new WebSocket(`wss://${window.location.hostname}/ws`);
    
    ws.onmessage = async function(event) {
        const data = JSON.parse(event.data);
        
        switch(data.type) {
            case 'booking_update':
                await loadBookings();
                await updateCalendarStatus();
                break;
            case 'date_closed':
                await loadClosedDates();
                await updateCalendarStatus();
                break;
            case 'user_approved':
                if (currentUser?.role === 'admin') {
                    await loadPendingUsers();
                }
                break;
        }
    };

    ws.onclose = function() {
        // 연결이 끊어지면 3초 후 재연결 시도
        setTimeout(initializeWebSocket, 3000);
    };
}

// 웹소켓 초기화 호출
initializeWebSocket();
</script>
</body>
</html>

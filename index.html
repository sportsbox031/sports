<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스포츠박스 예약시스템</title>
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .calendar-day:hover {
            background-color: rgba(59, 130, 246, 0.1);
            transition: all 0.3s;
        }
        .selected {
            background-color: #3B82F6 !important;
            color: white !important;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal.show {
            display: flex;
        }
        .calendar-day.booked {
            background-color: #FEF3C7;
            cursor: pointer;
        }
        .calendar-day.full {
            background-color: #FEE2E2;
            cursor: not-allowed;
        }
        .calendar-day.past {
            background-color: #F3F4F6;
            cursor: not-allowed;
            color: #9CA3AF;
        }
        .calendar-day.blocked {
            background-color: #4B5563 !important;
            color: white !important;
            cursor: not-allowed;
        }
        .calendar-day.today {
            font-weight: bold;
            background-color: transparent !important;
        }
        #adminCalendar .calendar-day.blocked {
            cursor: pointer;
        }
        .calendar-day.blocked:hover {
            background-color: #374151 !important;
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loading.show {
            display: flex;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">
    <!-- 로딩 인디케이터 -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
    </div>

    <!-- 알림 메시지 -->
    <div id="alert" class="fixed top-4 right-4 max-w-sm bg-white rounded-lg shadow-lg p-4 hidden z-50">
        <div class="flex items-center">
            <div id="alertIcon" class="flex-shrink-0">
                <i class="fas fa-info-circle text-blue-500"></i>
            </div>
            <div class="ml-3">
                <p id="alertMessage" class="text-sm text-gray-700"></p>
            </div>
            <button onclick="hideAlert()" class="ml-4">
                <i class="fas fa-times text-gray-400 hover:text-gray-500"></i>
            </button>
        </div>
    </div>

    <!-- 로그인 화면 -->
    <div id="loginScreen" class="min-h-screen bg-gray-100 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-md w-96">
            <h1 class="text-2xl font-bold mb-6 text-center">스포츠박스 로그인</h1>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">아이디</label>
                    <input type="text" id="username" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">비밀번호</label>
                    <input type="password" id="password" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>
                <button type="submit" 
                    class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                    로그인
                </button>
            </form>
            <button id="showSignup" 
                class="w-full mt-4 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition duration-200">
                회원가입
            </button>
        </div>
    </div>

    <!-- 회원가입 모달 -->
    <div id="signupModal" class="modal">
        <div class="bg-white p-8 rounded-lg shadow-md w-96 m-auto">
            <h2 class="text-2xl font-bold mb-6 text-center">회원가입</h2>
            <form id="signupForm" class="space-y-4">
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">단체명</label>
                    <input type="text" id="groupName" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">비밀번호</label>
                    <input type="password" id="signupPassword" required minlength="6"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <p class="text-sm text-gray-500 mt-1">6자 이상 입력해주세요</p>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">담당자</label>
                    <input type="text" id="manager" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">연락처</label>
                    <input type="text" id="contact" required
                        placeholder="예: 010-1234-5678"
                        pattern="[0-9]{2,3}-[0-9]{3,4}-[0-9]{4}"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <p class="text-sm text-gray-500 mt-1">형식: 010-0000-0000</p>
                </div>
                <button type="submit" 
                    class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                    가입하기
                </button>
                <button type="button" id="closeSignup"
                    class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition duration-200">
                    닫기
                </button>
            </form>
        </div>
    </div>

    <!-- 사용자 대시보드 -->
    <div id="userDashboard" class="hidden">
        <nav class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-running text-2xl"></i>
                        <span class="text-2xl font-bold">스포츠박스</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="userGroupName" class="text-sm"></span>
                        <button id="logoutBtn" class="hover:text-blue-200 transition-colors duration-200 flex items-center space-x-1">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>로그아웃</span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <main class="container mx-auto px-4 py-8">
            <div class="grid md:grid-cols-2 gap-8">
                <!-- 캘린더 섹션 -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-700">예약 현황</h2>
                        <div class="flex space-x-4">
                            <button id="prevMonth" class="p-2 hover:bg-blue-100 rounded-full transition-colors duration-200">
                                <i class="fas fa-chevron-left text-blue-600"></i>
                            </button>
                            <span id="currentMonth" class="p-2 font-medium text-gray-700"></span>
                            <button id="nextMonth" class="p-2 hover:bg-blue-100 rounded-full transition-colors duration-200">
                                <i class="fas fa-chevron-right text-blue-600"></i>
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-7 gap-2 mb-2">
                        <div class="text-center font-medium text-gray-600">일</div>
                        <div class="text-center font-medium text-gray-600">월</div>
                        <div class="text-center font-medium text-gray-600">화</div>
                        <div class="text-center font-medium text-gray-600">수</div>
                        <div class="text-center font-medium text-gray-600">목</div>
                        <div class="text-center font-medium text-gray-600">금</div>
                        <div class="text-center font-medium text-gray-600">토</div>
                    </div>
                    <div id="calendar" class="grid grid-cols-7 gap-2"></div>
                    <div class="mt-4 flex justify-end space-x-4">
                        <div class="flex items-center">
                            <div class="w-4 h-4 bg-yellow-100 rounded mr-2"></div>
                            <span class="text-sm text-gray-600">예약가능</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-4 h-4 bg-red-100 rounded mr-2"></div>
                            <span class="text-sm text-gray-600">예약마감</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-4 h-4 bg-gray-600 rounded mr-2"></div>
                            <span class="text-sm text-gray-600">관리자 마감</span>
                        </div>
                    </div>
                </div>

                <!-- 예약 정보 섹션 -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-700">예약하기</h2>
                        <div id="remainingBookings" class="text-sm font-medium text-green-600">
                            이번 달 남은 예약 가능 횟수: 4회
                        </div>
                    </div>
                    <form id="bookingForm" class="space-y-6">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">선택된 날짜</label>
                            <input type="text" id="selectedDate" readonly required
                                class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">시작 시간</label>
                                <select id="startTime" required
                                    class="w-full p-3 border border-gray-300 rounded-lg">
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">종료 시간</label>
                                <select id="endTime" required
                                    class="w-full p-3 border border-gray-300 rounded-lg">
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">인원</label>
                                <input type="number" id="people" required min="1"
                                    class="w-full p-3 border border-gray-300 rounded-lg">
                                <p class="text-sm text-gray-500 mt-1">수업 인원을 입력하세요</p>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">장소</label>
                                <input type="text" id="place" required
                                    class="w-full p-3 border border-gray-300 rounded-lg"
                                    placeholder="수업 장소를 입력하세요">
                            </div>
                        </div>
                        <button type="submit" 
    class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
    예약하기
</button>
                    </form>
                </div>

                <!-- 내 예약 목록 -->
                <div class="mt-8 bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-700 mb-6">내 예약 목록</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        날짜
                                    </th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        시간
                                    </th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        장소
                                    </th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        인원
                                    </th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        상태
                                    </th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        관리
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="bookingsList" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 관리자 대시보드 -->
    <div id="adminDashboard" class="hidden">
        <nav class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-running text-2xl"></i>
                        <span class="text-2xl font-bold">스포츠박스 관리자</span>
                    </div>
                    <div class="flex space-x-8">
                        <button id="adminLogoutBtn" class="hover:text-blue-200 transition-colors duration-200 flex items-center space-x-1">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>로그아웃</span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <main class="container mx-auto px-4 py-8">
            <!-- 캘린더 섹션 -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-bold text-gray-800">예약 현황</h2>
                    <div class="flex items-center space-x-6">
                        <button id="downloadExcel" 
                            class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 flex items-center transition-colors duration-200">
                            <i class="fas fa-file-excel mr-2"></i>
                            월간 일정표 다운로드
                        </button>
                        <div class="flex items-center space-x-4 bg-gray-50 p-2 rounded-lg">
                            <button id="adminPrevMonth" class="p-2 hover:bg-blue-100 rounded-full transition-colors duration-200">
                                <i class="fas fa-chevron-left text-blue-600"></i>
                            </button>
                            <span id="adminCurrentMonth" class="text-lg font-medium text-gray-700 min-w-[120px] text-center"></span>
                            <button id="adminNextMonth" class="p-2 hover:bg-blue-100 rounded-full transition-colors duration-200">
                                <i class="fas fa-chevron-right text-blue-600"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 캘린더 그리드 -->
                <div class="mb-4">
                    <div class="grid grid-cols-7 gap-2 mb-2">
                        <div class="text-center font-semibold text-gray-600 py-2">일</div>
                        <div class="text-center font-semibold text-gray-600 py-2">월</div>
                        <div class="text-center font-semibold text-gray-600 py-2">화</div>
                        <div class="text-center font-semibold text-gray-600 py-2">수</div>
                        <div class="text-center font-semibold text-gray-600 py-2">목</div>
                        <div class="text-center font-semibold text-gray-600 py-2">금</div>
                        <div class="text-center font-semibold text-gray-600 py-2">토</div>
                    </div>
                    <div id="adminCalendar" class="grid grid-cols-7 gap-2"></div>
                </div>
    
                <!-- 캘린더 범례 -->
                <div class="flex justify-end space-x-6 pt-4 border-t">
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-yellow-100 rounded mr-2"></div>
                        <span class="text-sm text-gray-600">예약가능</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-red-100 rounded mr-2"></div>
                        <span class="text-sm text-gray-600">예약마감</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-gray-600 rounded mr-2"></div>
                        <span class="text-sm text-gray-600">관리자 마감</span>
                    </div>
                </div>
            </div>
    
            <!-- 회원가입 승인 목록 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white rounded-lg shadow-lg p-8">
                    <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-user-plus text-blue-500 mr-2"></i>
                        회원가입 승인 대기
                    </h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">단체명</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">담당자</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">연락처</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">관리</th>
                                </tr>
                            </thead>
                            <tbody id="pendingUsersList" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
    
                <!-- 예약 승인 목록 -->
                <div class="bg-white rounded-lg shadow-lg p-8">
                    <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-calendar-check text-blue-500 mr-2"></i>
                        예약 승인 대기
                    </h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">단체명</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">날짜</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">시간</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">관리</th>
                                </tr>
                            </thead>
                            <tbody id="pendingBookingsList" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 날짜별 예약 내역 모달 -->
    <div id="dateBookingsModal" class="modal">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-2xl m-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modalDate" class="text-xl font-bold text-gray-700"></h2>
                <button id="closeDateBookingsModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4 flex justify-end space-x-2">
                <button id="blockDateBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                    마감 처리
                </button>
                <button id="unblockDateBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 hidden">
                    마감 해제
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                단체명
                            </th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                시간
                            </th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                장소
                            </th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                인원
                            </th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                상태
                            </th>
                        </tr>
                    </thead>
                    <tbody id="dateBookingsList" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Excel.js 라이브러리 추가 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

    <!-- 메인 JavaScript 코드 -->
    <script>
        const API_BASE_URL = 'https://sports-box-api.sportsbox031.workers.dev';
        const DEBUG = true;

        // 관리자 계정 정보
        const ADMIN_CREDENTIALS = {
            username: 'admin',
            password: 'admin123'
        };

        let currentUser = null;
        let bookingStatus = {};
        let isLoading = false;

        // 로딩 인디케이터 제어
        function showLoading() {
            if (!isLoading) {
                isLoading = true;
                document.getElementById('loading').classList.add('show');
            }
        }

        function hideLoading() {
            isLoading = false;
            document.getElementById('loading').classList.remove('show');
        }

        // 알림 메시지 표시
        function showAlert(message, type = 'info') {
            const alert = document.getElementById('alert');
            const alertMessage = document.getElementById('alertMessage');
            const alertIcon = document.getElementById('alertIcon').firstElementChild;

            alertMessage.textContent = message;
            alert.classList.remove('hidden');

            switch(type) {
                case 'success':
                    alertIcon.className = 'fas fa-check-circle text-green-500';
                    break;
                case 'error':
                    alertIcon.className = 'fas fa-exclamation-circle text-red-500';
                    break;
                default:
                    alertIcon.className = 'fas fa-info-circle text-blue-500';
            }

            setTimeout(hideAlert, 3000);
        }

        function hideAlert() {
            document.getElementById('alert').classList.add('hidden');
        }

// API 요청 헬퍼 함수
        async function apiRequest(endpoint, options = {}) {
            showLoading();
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : '',
                        ...options.headers
                    }
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.message || `HTTP error! status: ${response.status}`);
                }

                return data;
            } catch (error) {
                console.error('API Request Error:', error);
                throw error;
            } finally {
                hideLoading();
            }
        }

        // 월별 예약 데이터 조회
        async function fetchMonthlyBookings(year, month) {
            try {
                const response = await apiRequest(`/api/admin/bookings/month/${year}/${month}`);
                return response.data;
            } catch (error) {
                console.error('Error fetching monthly bookings:', error);
                showAlert('월간 예약 데이터 조회 중 오류가 발생했습니다.', 'error');
                return null;
            }
        }

        // 엑셀 데이터 생성
        async function generateExcelData(year, month) {
    try {
        const bookings = await fetchMonthlyBookings(year, month);
        if (!bookings) return null;

        // 워크시트 데이터 생성
        const wsData = [];
        
        // 제목 행 추가
        wsData.push([`${year}년 ${month}월 스포츠박스 예약 현황`]);
        wsData.push([]); // 빈 행 추가

        // 요일 헤더 추가
        wsData.push(['일', '월', '화', '수', '목', '금', '토']);

        // 달력 데이터 생성
        const firstDay = new Date(year, month - 1, 1);
        const lastDay = new Date(year, month, 0);
        let currentWeek = new Array(7).fill('');
        let weekData = [];

        // 첫 주의 시작 전 빈 셀 채우기
        for (let i = 0; i < firstDay.getDay(); i++) {
            currentWeek[i] = '';
        }

        // 날짜 채우기
        for (let day = 1; day <= lastDay.getDate(); day++) {
            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            let cellContent = day.toString();

            // 해당 날짜의 예약 정보 추가
            if (bookings[dateStr] && bookings[dateStr].length > 0) {
                cellContent += '\n' + bookings[dateStr]
                    .map(booking => `${booking.group_name}\n${booking.start_time}-${booking.end_time}`)
                    .join('\n\n');
            }

            currentWeek[new Date(year, month - 1, day).getDay()] = cellContent;

            // 주가 끝나면 새로운 주 시작
            if (new Date(year, month - 1, day).getDay() === 6) {
                weekData.push([...currentWeek]);
                currentWeek = new Array(7).fill('');
            }
        }

        // 마지막 주 추가
        if (currentWeek.some(cell => cell !== '')) {
            weekData.push([...currentWeek]);
        }

        // 주 데이터를 워크시트에 추가
        weekData.forEach(week => {
            wsData.push(week);
        });

        // 워크시트 생성
        const ws = XLSX.utils.aoa_to_sheet(wsData);

        // 스타일 설정
        const range = XLSX.utils.decode_range(ws['!ref']);
        
        // 열 너비 설정 (모든 열 동일하게)
        ws['!cols'] = Array(7).fill({ wch: 25 });

        // 행 높이 설정
        ws['!rows'] = Array(range.e.r + 1).fill({ hpt: 100 }); // 높이 조정

        // 제목 행 병합
        ws['!merges'] = [
            { s: { r: 0, c: 0 }, e: { r: 0, c: 6 } }
        ];

        // 스타일 적용
        for (let R = 0; R <= range.e.r; R++) {
            for (let C = 0; C <= range.e.c; C++) {
                const cellRef = XLSX.utils.encode_cell({ r: R, c: C });
                if (!ws[cellRef]) continue;

                // 기본 셀 스타일
                ws[cellRef].s = {
                    alignment: { vertical: 'top', horizontal: 'left', wrapText: true },
                    border: {
                        top: { style: 'thin', color: { rgb: "000000" } },
                        bottom: { style: 'thin', color: { rgb: "000000" } },
                        left: { style: 'thin', color: { rgb: "000000" } },
                        right: { style: 'thin', color: { rgb: "000000" } }
                    },
                    font: { sz: 10 }
                };

                // 제목 행 스타일
                if (R === 0) {
                    ws[cellRef].s = {
                        ...ws[cellRef].s,
                        font: { bold: true, sz: 14 },
                        fill: { fgColor: { rgb: "4472C4" } },
                        font: { color: { rgb: "FFFFFF" } },
                        alignment: { horizontal: 'center', vertical: 'center' }
                    };
                }

                // 요일 헤더 스타일
                if (R === 2) {
                    ws[cellRef].s = {
                        ...ws[cellRef].s,
                        font: { bold: true },
                        fill: { fgColor: { rgb: "E2EFDA" } },
                        alignment: { horizontal: 'center', vertical: 'center' }
                    };
                }

                // 주말 색상
                if (R > 2) {
                    if (C === 0) { // 일요일
                        ws[cellRef].s = {
                            ...ws[cellRef].s,
                            fill: { fgColor: { rgb: "FFE6E6" } }
                        };
                    }
                    if (C === 6) { // 토요일
                        ws[cellRef].s = {
                            ...ws[cellRef].s,
                            fill: { fgColor: { rgb: "E6F0FF" } }
                        };
                    }
                }
            }
        }

        return ws;
    } catch (error) {
        console.error('Error generating Excel data:', error);
        return null;
    }
}

        // 날짜 포맷 함수
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일`;
        }

        // 상태에 따른 스타일 클래스 반환
        function getStatusClass(status) {
            switch(status) {
                case 'approved':
                    return 'bg-green-100 text-green-800';
                case 'pending':
                    return 'bg-yellow-100 text-yellow-800';
                case 'rejected':
                    return 'bg-red-100 text-red-800';
                case 'cancelled':
                    return 'bg-gray-100 text-gray-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        // 상태 텍스트 변환
        function getStatusText(status) {
            switch(status) {
                case 'approved':
                    return '승인완료';
                case 'pending':
                    return '승인대기';
                case 'rejected':
                    return '거부됨';
                case 'cancelled':
                    return '취소됨';
                default:
                    return '알 수 없음';
            }
        }

        // 엑셀 다운로드 핸들러
        document.getElementById('downloadExcel')?.addEventListener('click', function() {
    const year = adminCurrentDate.getFullYear();
    const month = adminCurrentDate.getMonth() + 1;
    
    if (!confirm(`${year}년 ${month}월 예약 현황을 다운로드하시겠습니까?`)) {
        return;
    }

    showLoading();
    generateExcelData(year, month)
        .then(ws => {
            if (!ws) {
                throw new Error('엑셀 데이터 생성 실패');
            }

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, `${year}년 ${month}월`);
            
            const timestamp = new Date().toISOString().slice(0, 10);
            const fileName = `스포츠박스_예약현황_${year}년${month}월_${timestamp}.xlsx`;
            
            XLSX.writeFile(wb, fileName);
            showAlert('엑셀 파일이 다운로드되었습니다.', 'success');
        })
        .catch(error => {
            console.error('Excel download error:', error);
            showAlert('엑셀 파일 다운로드 중 오류가 발생했습니다.', 'error');
        })
        .finally(() => {
            hideLoading();
        });
});

        // 로그인/로그아웃 관련 함수
        async function login(username, password) {
            try {
                const response = await apiRequest('/api/login', {
                    method: 'POST',
                    body: JSON.stringify({ username, password })
                });

                if (response.success) {
                    localStorage.setItem('token', response.token);
                    localStorage.setItem('role', response.role);
                    localStorage.setItem('username', response.username);
                    
                    showDashboard(response.role);
                    showAlert('로그인되었습니다.', 'success');
                }
            } catch (error) {
                console.error('Login error:', error);
                showAlert(error.message || '로그인에 실패했습니다.', 'error');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('role');
            localStorage.removeItem('username');
            
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('userDashboard').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            
            showAlert('로그아웃되었습니다.', 'info');
        }

        function showDashboard(role) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('userDashboard').style.display = 'none';

            if (role === 'admin') {
                document.getElementById('adminDashboard').style.display = 'block';
                initializeAdminCalendar();
                updateCalendarStatus();
                loadPendingUsers();
                loadPendingBookings();
            } else {
                document.getElementById('userDashboard').style.display = 'block';
                if (localStorage.getItem('username')) {
                    document.getElementById('userGroupName').textContent = 
                        localStorage.getItem('username');
                }
                initializeCalendar();
                updateCalendarStatus();
                loadBookings();
            }
        }

        // 회원가입 관련 함수
        async function signup(formData) {
          try {
              const response = await apiRequest('/api/signup', {
                  method: 'POST',
                  body: JSON.stringify(formData)
              });

              if (response.success) {
                  showAlert('회원가입 신청이 완료되었습니다. 관리자 승인을 기다려주세요.', 'success');
                  document.getElementById('signupModal').classList.remove('show');
                  document.getElementById('signupForm').reset();
              }
          } catch (error) {
              console.error('Signup error:', error);
              showAlert(error.message || '회원가입 처리 중 오류가 발생했습니다.', 'error');
          }
      }

      // 날짜 마감/해제 함수
      async function blockDate(date) {
          try {
              const response = await apiRequest('/api/admin/dates/block', {
                  method: 'POST',
                  body: JSON.stringify({ date })
              });
              if (response.success) {
                  showAlert('날짜가 마감 처리되었습니다.', 'success');
                  await updateCalendarStatus();
              }
          } catch (error) {
              console.error('Date blocking error:', error);
              showAlert('날짜 마감 처리 중 오류가 발생했습니다.', 'error');
          }
      }

      async function unblockDate(date) {
          try {
              const response = await apiRequest('/api/admin/dates/unblock', {
                  method: 'POST',
                  body: JSON.stringify({ date })
              });
              if (response.success) {
                  showAlert('날짜 마감이 해제되었습니다.', 'success');
                  await updateCalendarStatus();
              }
          } catch (error) {
              console.error('Date unblocking error:', error);
              showAlert('날짜 마감 해제 중 오류가 발생했습니다.', 'error');
          }
      }

      // 예약 관련 함수들
      async function loadBookings() {
          try {
              const data = await apiRequest('/api/bookings');
              const tbody = document.getElementById('bookingsList');
              
              if (data.success && data.data) {
                  tbody.innerHTML = data.data
                      .filter(booking => booking.status !== 'cancelled')
                      .map(booking => {
                          const bookingDate = new Date(booking.date);
                          const today = new Date();
                          today.setHours(0, 0, 0, 0);
                          
                          const canCancel = bookingDate >= today && 
                              booking.status !== 'cancelled' && 
                              booking.status !== 'rejected';

                          return `
                              <tr>
                                  <td class="px-6 py-4 whitespace-nowrap">${formatDate(booking.date)}</td>
                                  <td class="px-6 py-4 whitespace-nowrap">${booking.start_time} - ${booking.end_time}</td>
                                  <td class="px-6 py-4 whitespace-nowrap">${booking.place}</td>
                                  <td class="px-6 py-4 whitespace-nowrap">${booking.people}명</td>
                                  <td class="px-6 py-4 whitespace-nowrap">
                                      <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                          ${getStatusClass(booking.status)}">
                                          ${getStatusText(booking.status)}
                                      </span>
                                  </td>
                                  <td class="px-6 py-4 whitespace-nowrap">
                                      ${canCancel ? `
                                          <button onclick="cancelBooking(${booking.id})" 
                                              class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm">
                                              취소
                                          </button>
                                      ` : ''}
                                  </td>
                              </tr>
                          `;
                      }).join('') || '<tr><td colspan="6" class="px-6 py-4 text-center">예약 내역이 없습니다.</td></tr>';
              }
          } catch (error) {
              console.error('Error loading bookings:', error);
              showAlert('예약 목록을 불러오는데 실패했습니다.', 'error');
          }
      }

      // 예약 생성
      async function createBooking(bookingData) {
    try {
        const response = await apiRequest('/api/bookings', {
            method: 'POST',
            body: JSON.stringify(bookingData)
        });

        if (response.success) {
            showAlert('예약이 신청되었습니다. 관리자 승인을 기다려주세요.', 'success');
            resetBookingForm(); // 여기에 추가
            await loadBookings();
            await updateCalendarStatus();
        }
    } catch (error) {
        console.error('Booking creation error:', error);
        showAlert(error.message || '예약 생성 중 오류가 발생했습니다.', 'error');
    }
}

      // 예약 취소
      async function cancelBooking(bookingId) {
          try {
              const response = await apiRequest(`/api/bookings/${bookingId}/cancel`, {
                  method: 'PUT'
              });
              if (response.success) {
                  showAlert('예약이 취소되었습니다.', 'success');
                  await loadBookings();
                  await updateCalendarStatus();
              }
          } catch (error) {
              console.error('Booking cancellation error:', error);
              showAlert(error.message || '예약 취소 중 오류가 발생했습니다.', 'error');
          }
      }

// 관리자: 가입 대기 사용자 목록 로드
        async function loadPendingUsers() {
            try {
                const data = await apiRequest('/api/admin/pending-users');
                const tbody = document.getElementById('pendingUsersList');
                
                if (data.success && data.data) {
                    tbody.innerHTML = data.data.map(user => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">${user.group_name}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${user.manager}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${user.contact}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <button onclick="approveUser(${user.id})" 
                                    class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 mr-2">
                                    승인
                                </button>
                                <button onclick="rejectUser(${user.id})" 
                                    class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                                    거부
                                </button>
                            </td>
                        </tr>
                    `).join('') || '<tr><td colspan="4" class="px-6 py-4 text-center">대기 중인 회원이 없습니다.</td></tr>';
                }
            } catch (error) {
                console.error('Error loading pending users:', error);
                showAlert('가입 대기 목록을 불러오는데 실패했습니다.', 'error');
            }
        }

        // 관리자: 사용자 승인/거부
        async function approveUser(userId) {
            try {
                const response = await apiRequest(`/api/admin/users/${userId}/approve`, {
                    method: 'PUT'
                });
                if (response.success) {
                    showAlert('사용자가 승인되었습니다.', 'success');
                    loadPendingUsers();
                }
            } catch (error) {
                console.error('User approval error:', error);
                showAlert('사용자 승인 처리 중 오류가 발생했습니다.', 'error');
            }
        }

        async function rejectUser(userId) {
            try {
                const response = await apiRequest(`/api/admin/users/${userId}/reject`, {
                    method: 'PUT'
                });
                if (response.success) {
                    showAlert('사용자가 거부되었습니다.', 'success');
                    loadPendingUsers();
                }
            } catch (error) {
                console.error('User rejection error:', error);
                showAlert('사용자 거부 처리 중 오류가 발생했습니다.', 'error');
            }
        }

        // 관리자: 예약 승인 대기 목록 로드
        async function loadPendingBookings() {
    try {
        const data = await apiRequest('/api/admin/pending-bookings');
        const tbody = document.getElementById('pendingBookingsList');
        
        if (data.success && data.data) {
            tbody.innerHTML = data.data.map(booking => {
                const createdAt = new Date(booking.created_at);
                const createdAtStr = new Intl.DateTimeFormat('ko-KR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                }).format(createdAt);

                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${booking.group_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${formatDate(booking.date)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm">
                                <div>시작: ${booking.start_time}</div>
                                <div>종료: ${booking.end_time}</div>
                                <div class="text-gray-500 text-xs mt-1">
                                    신청: ${createdAtStr}
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button onclick="approveBooking(${booking.id})" 
                                class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 mr-2">
                                승인
                            </button>
                            <button onclick="rejectBooking(${booking.id})" 
                                class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                                거부
                            </button>
                        </td>
                    </tr>
                `;
            }).join('') || '<tr><td colspan="4" class="px-6 py-4 text-center">대기 중인 예약이 없습니다.</td></tr>';
        }
    } catch (error) {
        console.error('Error loading pending bookings:', error);
        showAlert('예약 승인 대기 목록을 불러오는데 실패했습니다.', 'error');
    }
}

// 날짜별 예약 조회 함수
        async function loadDateBookings(dateString) {
            try {
                console.log('Loading bookings for date:', dateString);
                const data = await apiRequest(`/api/admin/bookings/date/${dateString}`);
                console.log('Received booking data:', data);

                const tbody = document.getElementById('dateBookingsList');
                const modalDate = document.getElementById('modalDate');
                const blockDateBtn = document.getElementById('blockDateBtn');
                const unblockDateBtn = document.getElementById('unblockDateBtn');
                
                modalDate.textContent = formatDate(dateString);

                const dateStatus = bookingStatus[dateString];
                if (dateStatus?.isBlocked) {
                    blockDateBtn.classList.add('hidden');
                    unblockDateBtn.classList.remove('hidden');
                } else {
                    blockDateBtn.classList.remove('hidden');
                    unblockDateBtn.classList.add('hidden');
                }

                if (data.success && data.data) {
                    tbody.innerHTML = data.data.map(booking => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">${booking.group_name}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${booking.start_time} - ${booking.end_time}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${booking.place}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${booking.people}명</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                    ${getStatusClass(booking.status)}">
                                    ${getStatusText(booking.status)}
                                </span>
                            </td>
                        </tr>
                    `).join('') || '<tr><td colspan="5" class="px-6 py-4 text-center">예약 내역이 없습니다.</td></tr>';
                }
            } catch (error) {
                console.error('Error loading date bookings:', error);
                console.error('Error details:', {
                    dateString,
                    error: error.message,
                    stack: error.stack
                });
                showAlert('예약 내역을 불러오는데 실패했습니다.', 'error');
            }
        }

        // 관리자: 예약 승인/거부
        async function approveBooking(bookingId) {
            try {
                const response = await apiRequest(`/api/admin/bookings/${bookingId}/approve`, {
                    method: 'PUT'
                });
                if (response.success) {
                    showAlert('예약이 승인되었습니다.', 'success');
                    loadPendingBookings();
                    updateCalendarStatus();
                }
            } catch (error) {
                console.error('Booking approval error:', error);
                showAlert('예약 승인 처리 중 오류가 발생했습니다.', 'error');
            }
        }

        async function rejectBooking(bookingId) {
            try {
                const response = await apiRequest(`/api/admin/bookings/${bookingId}/reject`, {
                    method: 'PUT'
                });
                if (response.success) {
                    showAlert('예약이 거부되었습니다.', 'success');
                    loadPendingBookings();
                    updateCalendarStatus();
                }
            } catch (error) {
                console.error('Booking rejection error:', error);
                showAlert('예약 거부 처리 중 오류가 발생했습니다.', 'error');
            }
        }

        // 예약 상태 조회 함수
        async function updateCalendarStatus() {
    try {
        const data = await apiRequest('/api/bookings/status');
        bookingStatus = data.data;

        const monthlyCount = Object.values(bookingStatus)
            .filter(status => status.isCurrentMonth && status.isMyBooking)
            .length;

        const remainingBookings = 4 - monthlyCount;
        const bookingCountElement = document.getElementById('remainingBookings');
        const submitButton = document.querySelector('#bookingForm button[type="submit"]');
        
        if (bookingCountElement) {
            bookingCountElement.textContent = `이번 달 남은 예약 가능 횟수: ${remainingBookings}회`;
            bookingCountElement.className = remainingBookings > 0 ? 
                'text-sm font-medium text-green-600' : 'text-sm font-medium text-red-600';
            
            // 예약 버튼 상태 업데이트
            if (submitButton) {
                if (remainingBookings <= 0) {
                    submitButton.disabled = true;
                    submitButton.classList.add('opacity-50', 'cursor-not-allowed');
                    submitButton.classList.remove('hover:bg-blue-700');
                } else {
                    submitButton.disabled = false;
                    submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    submitButton.classList.add('hover:bg-blue-700');
                }
            }
        }

        const role = localStorage.getItem('role');
        if (role === 'admin') {
            renderAdminCalendar(adminCurrentDate);
        } else {
            renderCalendar(currentDate);
        }
    } catch (error) {
        console.error('Calendar status update error:', error);
    }
}

        // 캘린더 관련 변수와 함수
        let currentDate = new Date();
        let adminCurrentDate = new Date();

        function initializeCalendar() {
            const calendar = document.getElementById('calendar');
            const currentMonthElement = document.getElementById('currentMonth');

            document.getElementById('prevMonth').addEventListener('click', function() {
    const newDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
    currentDate = newDate;
    renderCalendar(currentDate);
    updateCalendarStatus();
});

document.getElementById('nextMonth').addEventListener('click', function() {
    const newDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
    currentDate = newDate;
    renderCalendar(currentDate);
    updateCalendarStatus();
});

        function initializeAdminCalendar() {
            const adminCalendar = document.getElementById('adminCalendar');
            const adminCurrentMonthElement = document.getElementById('adminCurrentMonth');

            document.getElementById('adminPrevMonth').addEventListener('click', function() {
    const newDate = new Date(adminCurrentDate.getFullYear(), adminCurrentDate.getMonth() - 1, 1);
    adminCurrentDate = newDate;
    renderAdminCalendar(adminCurrentDate);
    updateCalendarStatus();
});

document.getElementById('adminNextMonth').addEventListener('click', function() {
    const newDate = new Date(adminCurrentDate.getFullYear(), adminCurrentDate.getMonth() + 1, 1);
    adminCurrentDate = newDate;
    renderAdminCalendar(adminCurrentDate);
    updateCalendarStatus();
});

        function renderCalendar(date) {
            const calendar = document.getElementById('calendar');
            const currentMonthElement = document.getElementById('currentMonth');
            
            const year = date.getFullYear();
            const month = date.getMonth();

            currentMonthElement.textContent = `${year}년 ${month + 1}월`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            calendar.innerHTML = '';

            // 첫째 날의 요일만큼 빈 칸 추가
            for (let i = 0; i < firstDay.getDay(); i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'h-12 rounded-lg';
                calendar.appendChild(emptyDay);
            }

            // 날짜 채우기
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dayElement = document.createElement('div');
                const selectedDateObj = new Date(year, month, day);
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dateStatus = bookingStatus[dateString];

                if (selectedDateObj < today) {
                    dayElement.className = 'calendar-day past h-12 flex items-center justify-center';
                    dayElement.title = '지난 날짜';
                } else if (dateStatus?.isBlocked) {
                    dayElement.className = 'calendar-day blocked h-12 flex items-center justify-center';
                    dayElement.title = '마감된 날짜';
                    dayElement.style.backgroundColor = '#4B5563';
                    dayElement.style.color = 'white';
                } else if (dateStatus?.isFull) {
                    dayElement.className = 'calendar-day full h-12 flex items-center justify-center';
                    dayElement.title = '예약 마감';
                } else if (dateStatus?.hasBooking) {
                    dayElement.className = 'calendar-day booked h-12 flex items-center justify-center cursor-pointer';
                    dayElement.title = `${dateStatus.bookingCount}개 예약됨`;
                    addDateClickHandler(dayElement, year, month, day);
                } else {
                    dayElement.className = 
                        'calendar-day h-12 flex items-center justify-center cursor-pointer rounded-lg hover:bg-blue-100 transition-colors text-gray-700';
                    addDateClickHandler(dayElement, year, month, day);
                }

                dayElement.textContent = day;

                if (
                    !dateStatus?.isBlocked && 
                    day === today.getDate() &&
                    currentDate.getMonth() === today.getMonth() &&
                    currentDate.getFullYear() === today.getFullYear()
                ) {
                    dayElement.classList.add('font-bold');
                }

                calendar.appendChild(dayElement);
            }
        }

        function renderAdminCalendar(date) {
            const adminCalendar = document.getElementById('adminCalendar');
            const adminCurrentMonthElement = document.getElementById('adminCurrentMonth');
            
            const year = date.getFullYear();
            const month = date.getMonth();

            adminCurrentMonthElement.textContent = `${year}년 ${month + 1}월`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            adminCalendar.innerHTML = '';

            // 첫째 날의 요일만큼 빈 칸 추가
            for (let i = 0; i < firstDay.getDay(); i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'h-12 rounded-lg';
                adminCalendar.appendChild(emptyDay);
            }

            // 날짜 채우기
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dayElement = document.createElement('div');
                const selectedDateObj = new Date(year, month, day);
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dateStatus = bookingStatus[dateString];

                if (selectedDateObj < today) {
                    dayElement.className = 'calendar-day past h-12 flex items-center justify-center';
                    dayElement.title = '지난 날짜';
                } else if (dateStatus?.isBlocked) {
                    dayElement.className = 'calendar-day blocked h-12 flex items-center justify-center cursor-pointer';
                    dayElement.title = '마감됨 (클릭하여 해제)';
                    dayElement.style.backgroundColor = '#4B5563';
                    dayElement.style.color = 'white';
                } else if (dateStatus?.isFull) {
                    dayElement.className = 'calendar-day full h-12 flex items-center justify-center';
                    dayElement.title = '예약 마감';
                } else if (dateStatus?.hasBooking) {
                    dayElement.className = 'calendar-day booked h-12 flex items-center justify-center cursor-pointer';
                    dayElement.title = `${dateStatus.bookingCount}개 예약됨`;
                } else {
                    dayElement.className = 
                        'calendar-day h-12 flex items-center justify-center cursor-pointer rounded-lg hover:bg-blue-100 transition-colors text-gray-700';
                    dayElement.title = '클릭하여 마감 처리';
                }

                // 관리자용 날짜 클릭 이벤트 (미래 날짜만)
                if (selectedDateObj >= today) {
                    dayElement.addEventListener('click', async function() {
                        const modal = document.getElementById('dateBookingsModal');
                        await loadDateBookings(dateString);
                        modal.classList.add('show');

                        // 마감 처리 버튼 이벤트
                        document.getElementById('blockDateBtn').onclick = async () => {
                            if (confirm('이 날짜를 마감 처리하시겠습니까?')) {
                                await blockDate(dateString);
                                await loadDateBookings(dateString);
                                await updateCalendarStatus();
                            }
                        };

                        document.getElementById('unblockDateBtn').onclick = async () => {
                            if (confirm('마감을 해제하시겠습니까?')) {
                                await unblockDate(dateString);
                                await loadDateBookings(dateString);
                                await updateCalendarStatus();
                            }
                        };
                    });
                }

                dayElement.textContent = day;

                if (
                    !dateStatus?.isBlocked && 
                    day === today.getDate() &&
                    adminCurrentDate.getMonth() === today.getMonth() &&
                    adminCurrentDate.getFullYear() === today.getFullYear()
                ) {
                    dayElement.classList.add('font-bold');
                }

                adminCalendar.appendChild(dayElement);
            }
        }

        function addDateClickHandler(element, year, month, day) {
            element.addEventListener('click', function() {
                const selected = document.querySelector('.selected');
                if (selected) {
                    selected.classList.remove('selected');
                }
                element.classList.add('selected');
                document.getElementById('selectedDate').value = `${year}년 ${month + 1}월 ${day}일`;
            });
        }

        // 시간 선택 초기화
        function initializeTimeSelects() {
            const startTimeSelect = document.getElementById('startTime');
            const endTimeSelect = document.getElementById('endTime');
            
            function generateTimeOptions() {
                const times = [];
                for (let hour = 9; hour < 18; hour++) {
                    for (let minute = 0; minute < 60; minute += 10) {
                        const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                        times.push(timeString);
                    }
                }
                return times;
            }

            const timeOptions = generateTimeOptions();
            
            startTimeSelect.innerHTML = '<option value="">선택해주세요</option>' + 
                timeOptions.map(time => `<option value="${time}">${time}</option>`).join('');

            startTimeSelect.addEventListener('change', function() {
                const selectedIndex = timeOptions.indexOf(this.value);
                endTimeSelect.innerHTML = '<option value="">선택해주세요</option>' + 
                    timeOptions.slice(selectedIndex + 1).map(time => `<option value="${time}">${time}</option>`).join('');
            });
        }

// 예약 폼 초기화 함수 추가
function resetBookingForm() {
    const form = document.getElementById('bookingForm');
    if (form) {
        form.reset();
        document.querySelector('.selected')?.classList.remove('selected');
        
        // 시간 선택 초기화
        const endTimeSelect = document.getElementById('endTime');
        if (endTimeSelect) {
            endTimeSelect.innerHTML = '<option value="">선택해주세요</option>';
        }
    }
}

// 이벤트 리스너 설정
document.addEventListener('DOMContentLoaded', function() {
    // 로그인 폼 제출
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        login(username, password);
    });

    // 회원가입 모달 컨트롤
    document.getElementById('showSignup').addEventListener('click', function() {
        document.getElementById('signupModal').classList.add('show');
    });

    document.getElementById('closeSignup').addEventListener('click', function() {
        document.getElementById('signupModal').classList.remove('show');
    });

    // 회원가입 폼 제출
    document.getElementById('signupForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = {
            groupName: document.getElementById('groupName').value,
            password: document.getElementById('signupPassword').value,
            manager: document.getElementById('manager').value,
            contact: document.getElementById('contact').value
        };
        signup(formData);
    });

    // 예약 폼 제출
    document.getElementById('bookingForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    const remainingBookingsElement = document.getElementById('remainingBookings');
    const remainingText = remainingBookingsElement.textContent;
    const remainingCount = parseInt(remainingText.match(/\d+/)[0]);

    if (remainingCount <= 0) {
        showAlert('이번 달 예약 가능 횟수(4회)를 모두 사용하셨습니다.', 'error');
        return;
    }

    const selectedDateText = document.getElementById('selectedDate').value;
    const dateParts = selectedDateText.match(/(\d+)년 (\d+)월 (\d+)일/);
    
    if (!dateParts) {
        showAlert('날짜를 선택해주세요.', 'error');
        return;
    }

    const bookingData = {
        date: `${dateParts[1]}-${String(dateParts[2]).padStart(2, '0')}-${String(dateParts[3]).padStart(2, '0')}`,
        startTime: document.getElementById('startTime').value,
        endTime: document.getElementById('endTime').value,
        people: document.getElementById('people').value,
        place: document.getElementById('place').value
    };

    createBooking(bookingData);
});

    // 로그아웃 버튼
    document.getElementById('logoutBtn')?.addEventListener('click', logout);
    document.getElementById('adminLogoutBtn')?.addEventListener('click', logout);

    // 날짜별 예약 모달 닫기
    document.getElementById('closeDateBookingsModal')?.addEventListener('click', function() {
        document.getElementById('dateBookingsModal').classList.remove('show');
    });

    // 엑셀 다운로드 버튼
    document.getElementById('downloadExcel')?.addEventListener('click', function() {
        const year = adminCurrentDate.getFullYear();
        const month = adminCurrentDate.getMonth() + 1;
        
        try {
            showLoading();
            if (!confirm(`${year}년 ${month}월 예약 현황을 다운로드하시겠습니까?`)) {
                hideLoading();
                return;
            }

            generateExcelData(year, month)
                .then(ws => {
                    if (!ws) {
                        throw new Error('엑셀 데이터 생성 실패');
                    }

                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, `${year}년 ${month}월`);
                    
                    const timestamp = new Date().toISOString().slice(0, 10);
                    const fileName = `스포츠박스_예약현황_${year}년${month}월_${timestamp}.xlsx`;
                    
                    XLSX.writeFile(wb, fileName);
                    showAlert('엑셀 파일이 다운로드되었습니다.', 'success');
                })
                .catch(error => {
                    console.error('Excel download error:', error);
                    showAlert('엑셀 파일 다운로드 중 오류가 발생했습니다.', 'error');
                })
                .finally(() => {
                    hideLoading();
                });
        } catch (error) {
            console.error('Excel download error:', error);
            showAlert('엑셀 파일 다운로드 중 오류가 발생했습니다.', 'error');
            hideLoading();
        }
    });

    // 시간 선택 초기화
    initializeTimeSelects();

    // 저장된 토큰이 있으면 자동 로그인
    const token = localStorage.getItem('token');
    const role = localStorage.getItem('role');
    if (token && role) {
        showDashboard(role);
    }
});

// 개발 모드일 때 콘솔 로그 출력
if (DEBUG) {
    window.onerror = function(msg, url, lineNo, columnNo, error) {
        console.error('Error: ' + msg + '\nURL: ' + url + '\nLine: ' + lineNo + '\nColumn: ' + columnNo + '\nError object: ' + JSON.stringify(error));
        return false;
    };
}
    </script>
</body>
</html>
